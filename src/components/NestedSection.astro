---
import { Image } from 'astro:assets';
import { marked } from 'marked';
import ProjectGallery from './ProjectGallery';

interface Column {
  type: 'content' | 'gallery' | 'image' | 'sections';
  title?: string;
  content?: string;
  src?: any;
  alt?: string;
  caption?: string;
  gallery?: Array<{
    src: any;
    alt: string;
    caption?: string;
  }>;
  galleryOptions?: {
    size?: 'small' | 'medium' | 'large' | 'full' | number;
    autoplay?: boolean;
    autoplayInterval?: number;
    showThumbnails?: boolean;
    showIndicators?: boolean;
  };
  sections?: Array<{
    columns: Column[];
  }>;
}

interface Section {
  columns: Column[];
}

interface Props {
  sections: Section[];
  depth?: number;
}

const { sections, depth = 0 } = Astro.props;

// Calculate appropriate heading levels based on nesting depth
const getHeadingLevel = (depth: number) => {
  if (depth === 0) return 'h2';
  if (depth === 1) return 'h3'; 
  if (depth === 2) return 'h4';
  if (depth === 3) return 'h5';
  return 'h6';
};

const getHeadingClass = (depth: number) => {
  if (depth === 0) return 'text-3xl font-bold mb-4';
  if (depth === 1) return 'text-2xl font-bold mb-4';
  if (depth === 2) return 'text-xl font-bold mb-4';
  if (depth === 3) return 'text-lg font-bold mb-3';
  return 'text-base font-bold mb-3';
};

const headingLevel = getHeadingLevel(depth);
const headingClass = getHeadingClass(depth);
---

<div class={`nested-sections space-y-${depth === 0 ? '12' : '8'}`}>
  {sections.map((section, i) => (
    <div class={`section gap-8 ${
      section.columns.length <= 2 ? 'flex flex-col lg:flex-row' :
      'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-' + section.columns.length
    }`}>
      {section.columns.map((col, j) => (
        <div class={`${
          section.columns.length === 1 ? 'w-full' :
          section.columns.length === 2 ? 'lg:w-1/2' :
          '' // Grid handles sizing for 3+ columns
        }`}>
          {col.type === 'content' && (
            <>
              {col.title && (
                <Fragment>
                  {headingLevel === 'h2' && <h2 class={headingClass}>{col.title}</h2>}
                  {headingLevel === 'h3' && <h3 class={headingClass}>{col.title}</h3>}
                  {headingLevel === 'h4' && <h4 class={headingClass}>{col.title}</h4>}
                  {headingLevel === 'h5' && <h5 class={headingClass}>{col.title}</h5>}
                  {headingLevel === 'h6' && <h6 class={headingClass}>{col.title}</h6>}
                </Fragment>
              )}
              <div class="prose prose-lg max-w-none" set:html={marked(col.content || '')} />
            </>
          )}
          
          {col.type === 'image' && col.src && (
            <>
              <Image 
                src={col.src} 
                alt={col.alt || ''} 
                width={600} 
                height={400} 
                class="w-full h-auto rounded-lg shadow-lg" 
              />
              {col.caption && (
                <p class="text-sm text-base-content/60 mt-2 text-center">{col.caption}</p>
              )}
            </>
          )}
          
          {col.type === 'gallery' && col.gallery && (
            <ProjectGallery
              images={col.gallery}
              autoplay={col.galleryOptions?.autoplay}
              autoplayInterval={col.galleryOptions?.autoplayInterval}
              showThumbnails={col.galleryOptions?.showThumbnails}
              showIndicators={col.galleryOptions?.showIndicators}
              size={col.galleryOptions?.size || 'medium'}
              client:load
            />
          )}
          
          {col.type === 'sections' && col.sections && (
            <div class={`nested-sections ${depth > 0 ? 'border-l-2 border-base-300 pl-4' : ''}`}>
              <Astro.self 
                sections={col.sections} 
                depth={depth + 1} 
              />
            </div>
          )}
        </div>
      ))}
    </div>
  ))}
</div>
